{% extends "base.html" %}

{% block title %}–ê–Ω–∞–ª–∏—Ç–∏–∫–∞ - –°–∫–ª–∞–¥ –ø—Ä–æ–¥—É–∫—Ç–æ–≤{% endblock %}
{% block header %}–ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –∏ –æ—Ç—á–µ—Ç—ã{% endblock %}

{% block content %}
<div class="analytics-header">
    <h2>üìä –ê–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏–µ –æ—Ç—á–µ—Ç—ã</h2>
    <p>–ó–¥–µ—Å—å –≤—ã –º–æ–∂–µ—Ç–µ –ø—Ä–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Ä–∞–∑–ª–∏—á–Ω—ã–µ –∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏–µ –¥–∞–Ω–Ω—ã–µ –ø–æ —Å–∫–ª–∞–¥—É</p>
</div>

<div class="analytics-sections">
    <!-- –¢–æ–≤–∞—Ä—ã —Å –∏—Å—Ç–µ–∫–∞—é—â–∏–º —Å—Ä–æ–∫–æ–º –≥–æ–¥–Ω–æ—Å—Ç–∏ -->
    <div class="analytics-section">
        <h3>‚è∞ –¢–æ–≤–∞—Ä—ã —Å –∏—Å—Ç–µ–∫–∞—é—â–∏–º —Å—Ä–æ–∫–æ–º –≥–æ–¥–Ω–æ—Å—Ç–∏</h3>
        <div class="filter-controls">
            <label for="days-filter">–ü–æ–∫–∞–∑–∞—Ç—å —Ç–æ–≤–∞—Ä—ã, —Å—Ä–æ–∫ –≥–æ–¥–Ω–æ—Å—Ç–∏ –∫–æ—Ç–æ—Ä—ã—Ö –∏—Å—Ç–µ–∫–∞–µ—Ç –≤ —Ç–µ—á–µ–Ω–∏–µ:</label>
            <select id="days-filter">
                <option value="30">30 –¥–Ω–µ–π</option>
                <option value="60">60 –¥–Ω–µ–π</option>
                <option value="90">90 –¥–Ω–µ–π</option>
            </select>
            <button onclick="loadExpiringProducts()" class="btn btn-primary">–û–±–Ω–æ–≤–∏—Ç—å</button>
        </div>
        <div id="expiring-products" class="chart-container">
            <div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</div>
        </div>
    </div>

    <!-- –¢–æ–≤–∞—Ä—ã —Å –Ω–∏–∑–∫–∏–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º -->
    <div class="analytics-section">
        <h3>üìâ –¢–æ–≤–∞—Ä—ã —Å –Ω–∏–∑–∫–∏–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º</h3>
        <div class="filter-controls">
            <label for="threshold-filter">–ü–æ—Ä–æ–≥ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞:</label>
            <select id="threshold-filter">
                <option value="50">–ú–µ–Ω–µ–µ 50</option>
                <option value="100" selected>–ú–µ–Ω–µ–µ 100</option>
                <option value="200">–ú–µ–Ω–µ–µ 200</option>
            </select>
            <button onclick="loadLowQuantityProducts()" class="btn btn-primary">–û–±–Ω–æ–≤–∏—Ç—å</button>
        </div>
        <div id="low-quantity-products" class="chart-container">
            <div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</div>
        </div>
    </div>

    <!-- –°–∞–º—ã–µ –¥–æ—Ä–æ–≥–∏–µ —Ç–æ–≤–∞—Ä—ã -->
    <div class="analytics-section">
        <h3>üí∞ –°–∞–º—ã–µ –¥–æ—Ä–æ–≥–∏–µ —Ç–æ–≤–∞—Ä—ã</h3>
        <div class="filter-controls">
            <label for="limit-filter">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–æ–≤–∞—Ä–æ–≤:</label>
            <select id="limit-filter">
                <option value="5">5</option>
                <option value="10" selected>10</option>
                <option value="20">20</option>
            </select>
            <button onclick="loadHighPriceProducts()" class="btn btn-primary">–û–±–Ω–æ–≤–∏—Ç—å</button>
        </div>
        <div id="high-price-products" class="chart-container">
            <div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</div>
        </div>
    </div>

    <!-- –ê–Ω–∞–ª–∏–∑ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º -->
    <div class="analytics-section">
        <h3>üìà –ê–Ω–∞–ª–∏–∑ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º</h3>
        <button onclick="loadSalesByCategory()" class="btn btn-primary">–ó–∞–≥—Ä—É–∑–∏—Ç—å –æ—Ç—á–µ—Ç</button>
        <div id="sales-by-category" class="chart-container">
            <div class="loading">–ù–∞–∂–º–∏—Ç–µ "–ó–∞–≥—Ä—É–∑–∏—Ç—å –æ—Ç—á–µ—Ç" –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö</div>
        </div>
    </div>
</div>

<div class="analytics-info">
    <h3>‚ÑπÔ∏è –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏</h3>
    <div class="info-grid">
        <div class="info-card">
            <h4>‚è∞ –°—Ä–æ–∫–∏ –≥–æ–¥–Ω–æ—Å—Ç–∏</h4>
            <p>–û—Ç—Å–ª–µ–∂–∏–≤–∞–π—Ç–µ —Ç–æ–≤–∞—Ä—ã —Å –∏—Å—Ç–µ–∫–∞—é—â–∏–º —Å—Ä–æ–∫–æ–º –≥–æ–¥–Ω–æ—Å—Ç–∏ –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –ø–æ—Ç–µ—Ä—å</p>
        </div>
        <div class="info-card">
            <h4>üìâ –û—Å—Ç–∞—Ç–∫–∏</h4>
            <p>–ö–æ–Ω—Ç—Ä–æ–ª–∏—Ä—É–π—Ç–µ –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ –æ—Å—Ç–∞—Ç–∫–∏ –¥–ª—è —Å–≤–æ–µ–≤—Ä–µ–º–µ–Ω–Ω–æ–≥–æ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è —Å–∫–ª–∞–¥–∞</p>
        </div>
        <div class="info-card">
            <h4>üí∞ –¶–µ–Ω—ã</h4>
            <p>–ê–Ω–∞–ª–∏–∑–∏—Ä—É–π—Ç–µ —Ü–µ–Ω–æ–≤—É—é –ø–æ–ª–∏—Ç–∏–∫—É –∏ —Å–∞–º—ã–µ –¥–æ—Ä–æ–≥–∏–µ –ø–æ–∑–∏—Ü–∏–∏</p>
        </div>
        <div class="info-card">
            <h4>üìà –ö–∞—Ç–µ–≥–æ—Ä–∏–∏</h4>
            <p>–û—Ü–µ–Ω–∏–≤–∞–π—Ç–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–æ–≤ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –∞—Å—Å–æ—Ä—Ç–∏–º–µ–Ω—Ç–∞</p>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    document.addEventListener('DOMContentLoaded', function() {
        loadExpiringProducts();
        loadLowQuantityProducts();
        loadHighPriceProducts();
    });

    function loadExpiringProducts() {
        const days = document.getElementById('days-filter').value;
        fetch(`/api/tovars_expiring_soon?days=${days}`)
            .then(response => response.json())
            .then(data => displayExpiringProducts(data));
    }

    function loadLowQuantityProducts() {
        const threshold = document.getElementById('threshold-filter').value;
        fetch(`/api/tovars_low_quantity?threshold=${threshold}`)
            .then(response => response.json())
            .then(data => displayLowQuantityProducts(data));
    }

    function loadHighPriceProducts() {
        const limit = document.getElementById('limit-filter').value;
        fetch(`/api/tovars_high_price?limit=${limit}`)
            .then(response => response.json())
            .then(data => displayHighPriceProducts(data));
    }

    function loadSalesByCategory() {
        fetch('/api/sales_by_category')
            .then(response => response.json())
            .then(data => displaySalesByCategory(data));
    }

    function displayExpiringProducts(data) {
        const container = document.getElementById('expiring-products');
        if (data.length === 0) {
            container.innerHTML = '<div class="no-data">‚úÖ –ù–µ—Ç —Ç–æ–≤–∞—Ä–æ–≤ —Å –∏—Å—Ç–µ–∫–∞—é—â–∏–º —Å—Ä–æ–∫–æ–º –≥–æ–¥–Ω–æ—Å—Ç–∏</div>';
            return;
        }

        let html = '<table><thead><tr><th>–¢–æ–≤–∞—Ä</th><th>–ö–∞—Ç–µ–≥–æ—Ä–∏—è</th><th>–°—Ä–æ–∫ –≥–æ–¥–Ω–æ—Å—Ç–∏</th><th>–û—Å—Ç–∞–ª–æ—Å—å –¥–Ω–µ–π</th></tr></thead><tbody>';
        data.forEach(item => {
            const daysLeft = item.days_until_expiry;
            const rowClass = daysLeft < 7 ? 'critical' : daysLeft < 30 ? 'warning' : '';
            html += `<tr class="${rowClass}">
                <td>–¢–æ–≤–∞—Ä #${item.id_tov}</td>
                <td>${item.category}</td>
                <td>${new Date(item.srok_god).toLocaleDateString()}</td>
                <td><strong>${daysLeft}</strong> –¥–Ω.</td>
            </tr>`;
        });
        html += '</tbody></table>';
        container.innerHTML = html;
    }

    function displayLowQuantityProducts(data) {
        const container = document.getElementById('low-quantity-products');
        if (data.length === 0) {
            container.innerHTML = '<div class="no-data">‚úÖ –í—Å–µ —Ç–æ–≤–∞—Ä—ã –≤ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–µ</div>';
            return;
        }

        let html = '<table><thead><tr><th>–¢–æ–≤–∞—Ä</th><th>–ö–∞—Ç–µ–≥–æ—Ä–∏—è</th><th>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ</th><th>–°–∫–ª–∞–¥</th></tr></thead><tbody>';
        data.forEach(item => {
            html += `<tr>
                <td>–¢–æ–≤–∞—Ä #${item.id_tov}</td>
                <td>${item.category}</td>
                <td><strong class="low-quantity">${item.kol}</strong></td>
                <td>${item.sklad}</td>
            </tr>`;
        });
        html += '</tbody></table>';
        container.innerHTML = html;
    }

    function displayHighPriceProducts(data) {
        const container = document.getElementById('high-price-products');
        if (data.length === 0) {
            container.innerHTML = '<div class="no-data">‚ùå –î–∞–Ω–Ω—ã–µ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</div>';
            return;
        }

        let html = '<table><thead><tr><th>–¢–æ–≤–∞—Ä</th><th>–ö–∞—Ç–µ–≥–æ—Ä–∏—è</th><th>–¶–µ–Ω–∞</th><th>–ï–¥. –∏–∑–º.</th></tr></thead><tbody>';
        data.forEach(item => {
            html += `<tr>
                <td>–¢–æ–≤–∞—Ä #${item.id_tov}</td>
                <td>${item.category}</td>
                <td><strong class="high-price">${item.cena} —Ä—É–±.</strong></td>
                <td>${item.ed_izm}</td>
            </tr>`;
        });
        html += '</tbody></table>';
        container.innerHTML = html;
    }

    function displaySalesByCategory(data) {
        const container = document.getElementById('sales-by-category');
        if (data.length === 0) {
            container.innerHTML = '<div class="no-data">‚ùå –î–∞–Ω–Ω—ã–µ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</div>';
            return;
        }

        let html = '<table><thead><tr><th>–ö–∞—Ç–µ–≥–æ—Ä–∏—è</th><th>–ö–æ–ª-–≤–æ —Ç–æ–≤–∞—Ä–æ–≤</th><th>–°—Ä–µ–¥–Ω—è—è —Ü–µ–Ω–∞</th><th>–û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ</th></tr></thead><tbody>';
        data.forEach(item => {
            html += `<tr>
                <td><strong>${item.category}</strong></td>
                <td>${item.product_count}</td>
                <td>${item.avg_price ? item.avg_price.toFixed(2) : 0} —Ä—É–±.</td>
                <td>${item.total_quantity || 0}</td>
            </tr>`;
        });
        html += '</tbody></table>';
        container.innerHTML = html;
    }
</script>
{% endblock %}